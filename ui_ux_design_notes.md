# PowerNap v2 - UI/UX 設計筆記 (AI & Human Readable)

**目標:** 本文檔定義 PowerNap v2 的 UI 結構、頁面設計和交互流程，供開發者參考並指導 AI 進行編碼。

---

## PART 1: AI 優化版本 (For Coding Implementation)

**AI 指令:** 在根據本文檔編寫 SwiftUI 代碼時，請嚴格遵循以下頁面結構、內容和交互描述。

### A1. 整體導航結構 (`App Root View`)

**指令:** 實現一個基於 `TabView` 的左右滑動分頁結構，包含以下四個頁面，**初始顯示主頁面 (Middle)**。

- **頁面 1 (Tab 1, Leading):** `SettingsAgeThresholdView` (用戶設定 - 年齡/閾值)
- **頁面 2 (Tab 2, Middle):** `MainNapView` (核心交互)
- **頁面 3 (Tab 3, Trailing 1):** `DebugDataView` (數據/狀態確認 - 開發用)
    - **AI 指令:** 此頁面需使用 `#if DEBUG` 或等效的條件編譯/運行時檢查 (`sandboxReceipt`) 包裹，使其僅在 Debug 或 TestFlight 版本中可見。
- **頁面 4 (Tab 4, Trailing 2):** `SettingsGeneralView` (其他設定與資訊)

**設計考量:** 需確保用戶能清晰區分並導航至各個頁面。

### A2. 頁面詳細設計


#### A2.1. 首次啟動流程 (`Onboarding Flow`)

**觸發條件:** App 首次啟動 (`isFirstLaunch == true`)。
**指令:** 創建一個導航流程，依次展示以下視圖：
    1.  `WelcomeView`: 顯示 App 名稱和歡迎語。
    2.  `IntroView`: 顯示 App 簡介 (50-100 字，內容可滾動)。
    3.  `PermissionsExplanationView`: 清晰、具體地解釋為何需要以下權限及其用途：
        *   HealthKit: 心率、靜息心率 (讀取 - 用於計算閾值、判斷睡眠)
        *   HealthKit: 睡眠分析 (寫入 - 用於記錄結果)
        *   HealthKit: 出生日期 (讀取 - 用於自動判斷年齡組)
        *   CoreMotion: 動作數據 (讀取 - 用於判斷靜止狀態)
        *   UserNotifications: 通知 (用於喚醒提醒)
    4.  `PermissionsRequestView`: 提供按鈕，觸發向系統請求上述權限。
    5.  完成後導航至 `MainNapView`。

#### A2.2. 主頁面 (`MainNapView`)

**指令:** 根據 `PowerNapViewModel` 的狀態 (`napState`: `.ready`, `.monitoring`, `.countdown`, `.paused` 等) 動態顯示不同內容。

- **狀態 `.ready**:**
    - 顯示 `DurationPicker` (或用戶已選時長)。
    - 顯示「開始休息」按鈕 (`Button`)。
- **狀態 `.monitoring` ("等待入睡")：**
    - 顯示「監測中」或類似文本。
    - **視覺效果:** 實現一個微妙的背景動畫 (例如，緩慢縮放或透明度變化的圓形)，模擬呼吸感，暗示正在運行。
    - **禁止顯示:** 不得顯示實時心率、閾值等內部數據。
    - 顯示「取消」按鈕 (`Button`)。
- **狀態 `.countdown**:**
    - 顯示格式化的剩餘時間 (`Text`, e.g., "MM:SS")。
    - 顯示「取消」按鈕 (`Button`)。
    - **新增:** 顯示「完成/醒來」按鈕 (`Button`)。

#### A2.3. 第二分頁 (`SettingsAgeThresholdView`)

**指令:** 實現以下設定選項，並將用戶選擇持久化 (例如使用 `UserDefaults`)，並綁定到 `PowerNapViewModel`。

- **年齡組:**
    - UI 元件: `Picker` 或 `SegmentedControl`。
    - 選項: 青少年 (Teen), 成人 (Adult), 銀髮族 (Senior)。
    - 邏輯: 應有選項允許用戶手動選擇，以覆蓋從 HealthKit 自動獲取的結果。
- **手動調整/放寬閾值:**
    - UI 元件: `Slider` (範圍 -5 到 +5，步長 1)。
    - 標籤: 左側顯示「判定較嚴格」，右側顯示「判定較寬鬆」。
    - 輔助說明: 「提示：若 App 難以偵測入睡，請向右調整 (寬鬆)；若容易誤判，請向左調整 (嚴格)。」
    - 綁定: 控制 `PowerNapViewModel` 中的 `thresholdAdjustmentPercentageOffset` (範圍 -0.05 到 +0.05)，影響 `SleepDetectionService` 使用的最終閾值百分比。

#### A2.4. 第三分頁 (`DebugDataView` - 僅 Debug/TestFlight)

**指令:** (僅在 Debug/TestFlight build 中) 顯示以下來自 `PowerNapViewModel` 或相關 Service 的內部狀態與數據，僅供開發者確認。

- 實時心率 (`currentHR`)
- 靜息心率 (`restingHR`)
- 計算出的睡眠心率閾值 (`sleepThresholdHR`)
- 動作水平 (`motionLevel`)
- 內部睡眠狀態機狀態 (`internalSleepState`)
- 其他有助於除錯的信息。

#### A2.5. 第四分頁 (`SettingsGeneralView`)

**指令:** 實現以下設定選項和資訊展示。

- **喚醒音效:** `Toggle` 開關，綁定 `isSoundEnabled`。
- **喚醒震動:** `Toggle` 開關，綁定 `isHapticEnabled`。
- **震動強度 (可選):** `Picker` 或 `SegmentedControl`，選項對應不同的 `WKHapticType` 或自定義觸感模式 (弱/中/強)。
- **通知總開關:** `Toggle` 開關 (如果需要獨立於系統設定)。
- **權限狀態顯示:** `Text` 標籤，顯示 HealthKit、通知等權限的當前狀態 (已授權/已拒絕)，並提供跳轉至系統設定的按鈕 (若被拒絕)。
- **回報/反饋按鈕:** `Button`，觸發郵件或反饋機制。

### A3. 視覺與交互

- **指令:** 編碼時注意以下幾點：
    - **風格一致性:** 確保所有視圖使用一致的字體、顏色、間距和組件風格。
    - **動畫:** 為 `MainNapView` 的 `.monitoring` 狀態實現指定的呼吸感背景動畫。考慮為其他狀態轉換添加平滑過渡。
    - **交互反饋:** 按鈕點擊應有視覺或觸覺 (`WKHapticFeedback`) 反饋。

---

## PART 2: 人類易讀版本 (Design Overview)

本文檔的此部分使用更具描述性的語言，概述 PowerNap v2 的界面流程和設計思路，方便人類讀者理解。

### B1. 整體導航結構

- App 採用常見的**左右滑動分頁**設計。
- 從左到右共有四個頁面，用戶打開 App 時默認看到中間的**主頁面**。
- **頁面順序與內容：**
  1.  **第二分頁 (最左側):** 這裡是用戶進行核心**算法相關設定**的地方，包括手動選擇或覆蓋**年齡組**，以及**微調睡眠判定的敏感度**（手動調整/放寬閾值）。
  2.  **主頁面 (中間):** 這是 App 的**核心交互區**。它會根據 App 的當前狀態（是在準備、監測用戶是否入睡，還是在倒數計時）顯示不同的界面和按鈕。
  3.  **第三分頁 (右側第一個):** 這個頁面主要用於**開發和測試階段**，顯示詳細的內部數據，如實時心率、靜息心率、動作狀態和睡眠判斷狀態等，方便開發者確認 App 是否按預期工作。**這個頁面在正式發布給普通用戶的版本中會被隱藏起來**。
  4.  **第四分頁 (最右側):** 包含其他的**通用設定**和信息，例如是否開啟喚醒**音效**和**震動**，顯示 App 所需的**權限狀態**（比如健康和通知權限是否已授予），以及提供**回報問題或反饋**的按鈕。
- **設計考慮:** 雖然有四個頁面，但通過將核心交互放中間、相關設定分組，力求讓用戶容易找到所需功能。

### B2. 頁面詳細設計

#### B2.1. 首次啟動 (Onboarding)

- 當用戶第一次打開 App 時，會看到一個引導流程：
    - 先是**歡迎**界面。
    - 然後是簡短的 **App 介紹** (大約 50-100 字，如果內容多可以滾動查看)。
    - 接著會**清楚解釋**為什麼 App 需要訪問用戶的健康數據（心率、睡眠記錄等）和通知權限，以及這些數據會被如何使用（這是 App Store 審核很看重的一點）。
    - 最後提供按鈕讓用戶**觸發系統的權限請求**。
    - 完成授權後，用戶會進入 App 的主頁面。

#### B2.2. 主頁面 (核心交互)

- 這個頁面的顯示內容會根據 App 的狀態動態變化：
    - **準備狀態：** 顯示用戶設定的休息時長（例如 5 分鐘）和一個「開始休息」按鈕。
    - **監測狀態 ("等待入睡")：**
        - 界面會提示「監測中」。為了不暴露算法細節，**不會顯示具體的心率數值**。
        - 但為了讓用戶知道 App 確實在工作，會加入一個**微妙的視覺效果**，比如背景出現**呼吸感的動畫**。
        - 同時提供一個「取消」按鈕。
    - **倒數計時狀態：**
        - 最顯眼的是**剩餘時間**。
        - 提供「取消」按鈕。
        - **新增**了一個「完成/醒來」按鈕，方便用戶在計時結束前手動結束。

#### B2.3. 第二分頁 (用戶設定 - 年齡/閾值)

- 這個頁面提供兩個核心的個性化設定：
    - **年齡組設定：** 允許用戶手動選擇自己的年齡段（青少年/成人/銀髮族），這個選擇會影響睡眠偵測的初始參數。App 會優先嘗試從 HealthKit 自動獲取，但這裡提供了手動覆蓋的選項。
    - **手動調整/放寬閾值：** 提供一個方式讓用戶微調睡眠偵測的敏感度。例如，如果用戶覺得 App 很難偵測到自己入睡，可以在這裡調整，讓偵測變得「更容易」一些（反之亦然）。UI 可能是一個滑桿或更友好的選項。

#### B2.4. 第三分頁 (數據/狀態確認 - 開發用)

- **用途：** 這個頁面是給開發者和測試者使用的，用來查看 App 內部的實時數據和狀態。
- **發布處理：** **正式版 App Store 中不會包含此頁面**。
- **顯示內容：** 心率、靜息心率、當前計算出的閾值、動作數據、睡眠狀態機的內部狀態等。

#### B2.5. 第四分頁 (其他設定與資訊)

- 這個頁面包含一些常規的設定和信息：
    - **喚醒音效**和**震動**的開關。
    - 未來可能加入**震動強度**的選擇（會基於系統提供的不同震動模式來實現）。
    - **通知**的總開關。
    - 顯示 App 所需的**權限狀態**（例如，健康數據是否已授權），如果權限被拒絕，會提供跳轉到系統設定的按鈕。
    - **回報/反饋**按鈕。

### B3. 視覺與交互

- 整體視覺風格（字體、顏色等）需要在所有頁面和狀態間保持**一致**。
- 在監測狀態加入**呼吸感背景動畫**，增加生動性。
- 按鈕點擊等交互操作需要有**清晰的響應**（視覺變化或震動反饋）。 